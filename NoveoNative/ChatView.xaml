<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:NoveoNative"
             x:Class="NoveoNative.ChatView"
             x:Name="ThisChatView"
             BackgroundColor="{Binding MainBgColor}">

    <ContentView.Resources>
        <ResourceDictionary>
            <!-- INCOMING -->
            <DataTemplate x:Key="IncomingMessageTemplate" x:DataType="local:MessageViewModel">
                <Grid Padding="5" ColumnDefinitions="40, *">

                    <!-- AVATAR -->
                    <Border Grid.Column="0" StrokeShape="RoundRectangle 20" HeightRequest="35" WidthRequest="35" VerticalOptions="End" Margin="0,0,5,5" StrokeThickness="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding OpenDMCommand}"/>
                        </Border.GestureRecognizers>
                        <Image Source="{Binding AvatarUrl}" Aspect="AspectFill" IsVisible="{Binding HasAvatar}"/>
                    </Border>
                    <Border Grid.Column="0" StrokeShape="RoundRectangle 20" HeightRequest="35" WidthRequest="35" VerticalOptions="End" Margin="0,0,5,5" StrokeThickness="0" BackgroundColor="{Binding AvatarBgColor}" IsVisible="{Binding HasNoAvatar}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding OpenDMCommand}"/>
                        </Border.GestureRecognizers>
                        <Label Text="{Binding SenderLetter}" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" FontAttributes="Bold"/>
                    </Border>

                    <Border Grid.Column="1" StrokeShape="RoundRectangle 0,15,15,15" StrokeThickness="0" BackgroundColor="{Binding BubbleColor}" HorizontalOptions="Start" MaximumWidthRequest="350" Padding="8">
                        <!-- âœ… FIXED: Context menu for mobile -->
                        <FlyoutBase.ContextFlyout>
                            <MenuFlyout>
                                <MenuFlyoutItem Text="Reply" Command="{Binding Source={x:Reference ThisChatView}, Path=CtxReplyCommand}" CommandParameter="{Binding .}"/>
                                <MenuFlyoutItem Text="Forward" Command="{Binding Source={x:Reference ThisChatView}, Path=CtxForwardCommand}" CommandParameter="{Binding .}"/>
                                <MenuFlyoutItem Text="Copy" Command="{Binding Source={x:Reference ThisChatView}, Path=CtxCopyCommand}" CommandParameter="{Binding .}"/>
                            </MenuFlyout>
                        </FlyoutBase.ContextFlyout>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer NumberOfTapsRequired="2" Command="{Binding Source={x:Reference ThisChatView}, Path=CtxReplyCommand}" CommandParameter="{Binding .}"/>
                        </Border.GestureRecognizers>

                        <VerticalStackLayout>
                            <Label Text="{Binding ForwardedLabel}" TextColor="Gray" FontSize="10" FontAttributes="Italic" IsVisible="{Binding IsForwarded}" Margin="0,0,0,5"/>
                            <Label Text="{Binding SenderName}" TextColor="Orange" FontSize="10" FontAttributes="Bold"/>
                            <Border IsVisible="{Binding IsReply}" BackgroundColor="{Binding ReplyQuoteColor}" StrokeThickness="0" Padding="5" Margin="0,2,0,5" StrokeShape="RoundRectangle 4">
                                <VerticalStackLayout>
                                    <Label Text="{Binding ReplyToName}" TextColor="{Binding SenderColor}" FontSize="9" FontAttributes="Bold"/>
                                    <Label Text="{Binding ReplyToText}" TextColor="{Binding TextColor}" FontSize="10" LineBreakMode="TailTruncation"/>
                                </VerticalStackLayout>
                            </Border>
                            <Image Source="{Binding FileUrl}" IsVisible="{Binding IsImage}" Aspect="AspectFit" HeightRequest="200" WidthRequest="200" Margin="0,5">
                                <Image.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ViewMediaCommand}"/>
                                </Image.GestureRecognizers>
                            </Image>
                            <StackLayout IsVisible="{Binding IsVideo}" BackgroundColor="Black" HeightRequest="150" WidthRequest="200" Margin="0,5">
                                <Label Text="â–¶ Video" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" FontSize="20"/>
                                <StackLayout.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding OpenFileCommand}"/>
                                </StackLayout.GestureRecognizers>
                            </StackLayout>
                            <StackLayout IsVisible="{Binding IsAudio}" BackgroundColor="{Binding AttachmentBgColor}" Padding="10" Margin="0,5" Orientation="Horizontal">
                                <Label Text="â–¶" TextColor="{Binding TextColor}" FontSize="18" VerticalOptions="Center" Margin="0,0,10,0"/>
                                <Label Text="Audio Clip" TextColor="{Binding TextColor}"/>
                                <StackLayout.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding OpenFileCommand}"/>
                                </StackLayout.GestureRecognizers>
                            </StackLayout>
                            <StackLayout IsVisible="{Binding ShowGenericFile}" Orientation="Horizontal" BackgroundColor="{Binding AttachmentBgColor}" Padding="8" Margin="0,5">
                                <StackLayout.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding OpenFileCommand}"/>
                                </StackLayout.GestureRecognizers>
                                <Label Text="ðŸ“„" TextColor="{Binding TextColor}" FontSize="18" VerticalOptions="Center"/>
                                <Label Text="{Binding FileName}" TextColor="{Binding TextColor}" LineBreakMode="MiddleTruncation" FontSize="12" VerticalOptions="Center" Margin="5,0,0,0"/>
                            </StackLayout>
                            <StackLayout IsVisible="{Binding IsTheme}" BackgroundColor="{Binding AttachmentBgColor}" Padding="10" Margin="0,5">
                                <Label Text="ðŸŽ¨ Theme" TextColor="{Binding TextColor}" FontAttributes="Bold"/>
                                <Label Text="{Binding ThemeName}" TextColor="{Binding TextColor}"/>
                            </StackLayout>
                            <Label FormattedText="{Binding MessageFormatted}" IsVisible="{Binding HasText}" FontSize="15"/>
                            <Label Text="{Binding Time}" TextColor="Gray" FontSize="9" HorizontalOptions="End"/>
                        </VerticalStackLayout>
                    </Border>
                </Grid>
            </DataTemplate>

            <!-- OUTGOING -->
            <DataTemplate x:Key="OutgoingMessageTemplate" x:DataType="local:MessageViewModel">
                <Grid Padding="5">
                    <Border StrokeShape="RoundRectangle 15,0,15,15" StrokeThickness="0" BackgroundColor="#3b82f6" HorizontalOptions="End" MaximumWidthRequest="350" Padding="8">
                        <!-- âœ… FIXED: Removed IsVisible - MenuFlyoutItem doesn't support it -->
                        <FlyoutBase.ContextFlyout>
                            <MenuFlyout>
                                <MenuFlyoutItem Text="Edit" Command="{Binding Source={x:Reference ThisChatView}, Path=CtxEditCommand}" CommandParameter="{Binding .}"/>
                                <MenuFlyoutItem Text="Reply" Command="{Binding Source={x:Reference ThisChatView}, Path=CtxReplyCommand}" CommandParameter="{Binding .}"/>
                                <MenuFlyoutItem Text="Forward" Command="{Binding Source={x:Reference ThisChatView}, Path=CtxForwardCommand}" CommandParameter="{Binding .}"/>
                                <MenuFlyoutItem Text="Copy" Command="{Binding Source={x:Reference ThisChatView}, Path=CtxCopyCommand}" CommandParameter="{Binding .}"/>
                                <MenuFlyoutItem Text="Delete" Command="{Binding Source={x:Reference ThisChatView}, Path=CtxDeleteCommand}" CommandParameter="{Binding .}" IsDestructive="True"/>
                            </MenuFlyout>
                        </FlyoutBase.ContextFlyout>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer NumberOfTapsRequired="2" Command="{Binding Source={x:Reference ThisChatView}, Path=CtxEditCommand}" CommandParameter="{Binding .}"/>
                        </Border.GestureRecognizers>

                        <VerticalStackLayout>
                            <Label Text="{Binding ForwardedLabel}" TextColor="#ddd" FontSize="10" FontAttributes="Italic" IsVisible="{Binding IsForwarded}" Margin="0,0,0,5"/>
                            <Border IsVisible="{Binding IsReply}" BackgroundColor="{Binding ReplyQuoteColor}" StrokeThickness="0" Padding="5" Margin="0,0,0,5" StrokeShape="RoundRectangle 4">
                                <VerticalStackLayout>
                                    <Label Text="{Binding ReplyToName}" TextColor="White" FontSize="9" FontAttributes="Bold"/>
                                    <Label Text="{Binding ReplyToText}" TextColor="White" FontSize="10" LineBreakMode="TailTruncation"/>
                                </VerticalStackLayout>
                            </Border>
                            <Image Source="{Binding FileUrl}" IsVisible="{Binding IsImage}" Aspect="AspectFit" HeightRequest="200" WidthRequest="200" Margin="0,5">
                                <Image.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ViewMediaCommand}"/>
                                </Image.GestureRecognizers>
                            </Image>
                            <StackLayout IsVisible="{Binding IsVideo}" BackgroundColor="Black" HeightRequest="150" WidthRequest="200" Margin="0,5">
                                <Label Text="â–¶ Video" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" FontSize="20"/>
                                <StackLayout.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding OpenFileCommand}"/>
                                </StackLayout.GestureRecognizers>
                            </StackLayout>
                            <StackLayout IsVisible="{Binding IsAudio}" BackgroundColor="{Binding AttachmentBgColor}" Padding="10" Margin="0,5" Orientation="Horizontal">
                                <Label Text="â–¶" TextColor="White" FontSize="18" VerticalOptions="Center" Margin="0,0,10,0"/>
                                <Label Text="Audio Clip" TextColor="White"/>
                                <StackLayout.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding OpenFileCommand}"/>
                                </StackLayout.GestureRecognizers>
                            </StackLayout>
                            <StackLayout IsVisible="{Binding ShowGenericFile}" Orientation="Horizontal" BackgroundColor="{Binding AttachmentBgColor}" Padding="8" Margin="0,5">
                                <StackLayout.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding OpenFileCommand}"/>
                                </StackLayout.GestureRecognizers>
                                <Label Text="ðŸ“„" TextColor="White" FontSize="18" VerticalOptions="Center"/>
                                <Label Text="{Binding FileName}" TextColor="White" LineBreakMode="MiddleTruncation" FontSize="12" VerticalOptions="Center" Margin="5,0,0,0"/>
                            </StackLayout>
                            <StackLayout IsVisible="{Binding IsTheme}" BackgroundColor="{Binding AttachmentBgColor}" Padding="10" Margin="0,5">
                                <Label Text="ðŸŽ¨ Theme" TextColor="White" FontAttributes="Bold"/>
                                <Label Text="{Binding ThemeName}" TextColor="White"/>
                            </StackLayout>
                            <Label FormattedText="{Binding MessageFormatted}" IsVisible="{Binding HasText}" FontSize="15"/>

                            <!-- Time with checkmarks -->
                            <StackLayout Orientation="Horizontal" HorizontalOptions="End" Spacing="3">
                                <Label Text="{Binding Time}" TextColor="#e0e0e0" FontSize="9"/>
                                <Label Text="{Binding SeenStatus}" TextColor="{Binding SeenCheckColor}" 
                           FontSize="10" FontAttributes="Bold" IsVisible="{Binding ShowSeenCheckmarks}"/>
                            </StackLayout>
                        </VerticalStackLayout>
                    </Border>
                </Grid>
            </DataTemplate>
        </ResourceDictionary>
    </ContentView.Resources>

    
    <Grid RowDefinitions="Auto,*,Auto,Auto,Auto">

        <!-- FIXED: Single unified header bar -->
        <Border Grid.Row="0" BackgroundColor="{Binding HeaderBgColor}" 
                Padding="10,40,10,10" StrokeThickness="0"
                IsVisible="{Binding HasActiveChat}">
            <Grid ColumnDefinitions="Auto,50,*,50">
                <!-- Back Button (Mobile Only) -->
                <Button Grid.Column="0" Text="â†" FontSize="24" TextColor="{Binding TextColor}" 
                        BackgroundColor="Transparent" Clicked="OnBackClicked" 
                        WidthRequest="40" HeightRequest="40"
                        IsVisible="{Binding ShowMobileBackButton}"/>

                <!-- Avatar -->
                <Border Grid.Column="1" StrokeShape="RoundRectangle 20" 
                        HeightRequest="40" WidthRequest="40" 
                        BackgroundColor="{Binding ChatAvatarBgColor}"
                        StrokeThickness="0">
                    <Grid>
                        <Label Text="{Binding ChatAvatarLetter}" TextColor="White" 
                               FontSize="18" FontAttributes="Bold"
                               HorizontalOptions="Center" VerticalOptions="Center"
                               IsVisible="{Binding ShowAvatarLetter}"/>
                        <Image Source="{Binding ChatAvatarUrl}" Aspect="AspectFill"
                               IsVisible="{Binding ShowAvatarImage}">
                            <Image.Clip>
                                <EllipseGeometry Center="20,20" RadiusX="20" RadiusY="20"/>
                            </Image.Clip>
                        </Image>
                    </Grid>
                </Border>

                <!-- Info -->
                <VerticalStackLayout Grid.Column="2" VerticalOptions="Center" Padding="10,0,0,0">
                    <Label Text="{Binding ChatName}" FontSize="16" FontAttributes="Bold" 
                           TextColor="{Binding TextColor}"/>
                    <!-- âœ… FIXED: Typing replaces subtitle -->
                    <Label Text="{Binding DisplaySubtitle}" FontSize="12" 
                           TextColor="{Binding SubtitleColor}"
                           FontAttributes="{Binding SubtitleFontAttributes}"/>
                </VerticalStackLayout>

                <!-- Menu Button -->
                <Button Grid.Column="3" Text="â‹®" FontSize="24" TextColor="{Binding TextColor}" 
                        BackgroundColor="Transparent" 
                        WidthRequest="40" HeightRequest="40"/>
            </Grid>
        </Border>

        <!-- Messages Container -->
        <Grid Grid.Row="1">
            <ActivityIndicator IsRunning="{Binding IsLoading}" IsVisible="{Binding IsLoading}" 
                               VerticalOptions="Center" HorizontalOptions="Center" 
                               Color="#3b82f6" HeightRequest="50" WidthRequest="50" ZIndex="5"/>

            <CollectionView x:Name="MessagesList" Margin="0,0,0,5">
                <CollectionView.ItemTemplate>
                    <local:MessageDataTemplateSelector 
                        IncomingMessageTemplate="{StaticResource IncomingMessageTemplate}"
                        OutgoingMessageTemplate="{StaticResource OutgoingMessageTemplate}"/>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>

        <!-- FIXED: Edit Mode Bar (NEW) -->
        <Grid Grid.Row="2" BackgroundColor="#f59e0b" Padding="10" IsVisible="{Binding IsEditing}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="30"/>
            </Grid.ColumnDefinitions>
            <Label Text="{Binding EditText}" TextColor="White" FontSize="12" FontAttributes="Bold" VerticalOptions="Center"/>
            <Button Grid.Column="1" Text="âœ•" BackgroundColor="Transparent" TextColor="White" Clicked="OnCancelEdit" Padding="0"/>
        </Grid>

        <!-- Preview Bar -->
        <Grid Grid.Row="3" BackgroundColor="#e0e0e0" Padding="10" IsVisible="{Binding IsPreviewActive}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="30"/>
            </Grid.ColumnDefinitions>
            <VerticalStackLayout>
                <Label Text="{Binding ReplyText}" TextColor="#3b82f6" FontSize="12" IsVisible="{Binding IsReplying}"/>
                <Label Text="{Binding ForwardText}" TextColor="#3b82f6" FontSize="12" IsVisible="{Binding IsForwarding}" FontAttributes="Bold"/>
                <StackLayout Orientation="Horizontal" IsVisible="{Binding IsFileAttached}">
                    <Label Text="ðŸ“Ž Attached: " TextColor="Black" FontAttributes="Bold"/>
                    <Label Text="{Binding AttachedFileName}" TextColor="Black"/>
                </StackLayout>
                <ProgressBar Progress="{Binding UploadProgress}" IsVisible="{Binding IsUploading}" WidthRequest="200" Margin="0,5"/>
            </VerticalStackLayout>
            <Button Grid.Column="1" Text="âœ•" BackgroundColor="Transparent" TextColor="Red" Clicked="OnCancelPreview" Padding="0"/>
        </Grid>

        <!-- Input Bar -->
        <Grid Grid.Row="4" ColumnDefinitions="Auto,*,Auto" Padding="10" 
              BackgroundColor="{Binding InputBgColor}" IsVisible="{Binding CanSend}">
            <Button Grid.Column="0" Text="ðŸ“Ž" BackgroundColor="Transparent" TextColor="#3b82f6" 
                    FontSize="22" Padding="0" Margin="0" Clicked="OnAttachClicked" 
                    WidthRequest="45" HeightRequest="45"/>
            <Border Grid.Column="1" StrokeShape="RoundRectangle 20" Stroke="LightGray" 
                    Padding="10,0" BackgroundColor="{Binding EntryBgColor}" Margin="5,0">
                <Entry x:Name="MsgEntry" Placeholder="Message..." TextColor="{Binding EntryTextColor}" 
                       PlaceholderColor="Gray" ReturnType="Send" Completed="OnEntryCompleted" 
                       ReturnCommand="{Binding SendCommand}"/>
            </Border>
            <Button Grid.Column="2" Text="âž¤" BackgroundColor="#3b82f6" TextColor="White" 
                    WidthRequest="50" HeightRequest="50" CornerRadius="25" Clicked="OnSendClicked"/>
        </Grid>

        <Label Grid.Row="4" Text="You cannot send messages in this channel." TextColor="Gray" 
               HorizontalOptions="Center" VerticalOptions="Center" 
               IsVisible="{Binding IsReadOnlyChannel}" Padding="15"/>
    </Grid>
</ContentView>
