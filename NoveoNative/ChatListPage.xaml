<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:NoveoNative"
             x:Class="NoveoNative.ChatListPage"
             BackgroundColor="{Binding MainBgColor}"
             NavigationPage.HasNavigationBar="False"
             Shell.NavBarIsVisible="False">

    <Grid RowDefinitions="*">

        <!-- LOGIN OVERLAY -->
        <Grid x:Name="LoginOverlay" BackgroundColor="{Binding MainBgColor}" ZIndex="999" IsVisible="{Binding IsLoginVisible}" InputTransparent="False">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer/>
            </Grid.GestureRecognizers>
            <VerticalStackLayout VerticalOptions="Center" Padding="30" Spacing="15">
                <Label Text="Noveo Native" FontSize="32" TextColor="#3b82f6" HorizontalOptions="Center" FontAttributes="Bold"/>
                <Entry x:Name="UserEntry" Placeholder="Username" TextColor="{Binding TextColor}" PlaceholderColor="Gray"/>
                <Entry x:Name="PassEntry" Placeholder="Password" IsPassword="True" TextColor="{Binding TextColor}" PlaceholderColor="Gray"/>
                <Button Text="{Binding LoginBtnText}" BackgroundColor="#3b82f6" TextColor="White" Clicked="OnLoginClicked"/>
                <Button Text="{Binding ToggleBtnText}" BackgroundColor="Transparent" TextColor="Gray" Clicked="OnToggleLoginMode" FontSize="12"/>
                <Label x:Name="StatusLabel" TextColor="Red" HorizontalOptions="Center"/>
            </VerticalStackLayout>
        </Grid>

        <!-- SPLIT VIEW -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="{Binding ListColumnWidth}" />
                <ColumnDefinition Width="{Binding ChatColumnWidth}" />
            </Grid.ColumnDefinitions>

            <!-- LEFT: LIST -->
            <Grid Grid.Column="0" BackgroundColor="{Binding MainBgColor}">
                <Grid RowDefinitions="Auto, *">

                    <!-- CUSTOM HEADER WITH HAMBURGER MENU -->
                    <Border Grid.Row="0" BackgroundColor="{Binding MainBgColor}" Padding="10,10" StrokeThickness="0">
                        <Grid ColumnDefinitions="Auto,*,Auto">

                            <!-- Hamburger Menu Button -->
                            <Button Grid.Column="0" 
                                    Text="☰" 
                                    BackgroundColor="Transparent" 
                                    TextColor="{Binding TextColor}" 
                                    FontSize="28" 
                                    Padding="8"
                                    Clicked="OnMenuClicked"
                                    WidthRequest="50" 
                                    HeightRequest="50"/>

                            <!-- Title -->
                            <Label Grid.Column="1" 
                                   Text="Noveo" 
                                   FontSize="22" 
                                   FontAttributes="Bold" 
                                   TextColor="#3b82f6" 
                                   VerticalOptions="Center" 
                                   HorizontalOptions="Start"
                                   Margin="10,0,0,0"/>

                            <!-- Create Channel Button -->
                            <Button Grid.Column="2" 
                                    Text="+" 
                                    BackgroundColor="Transparent" 
                                    TextColor="{Binding TextColor}" 
                                    FontSize="24" 
                                    Clicked="OnCreateChannel" 
                                    WidthRequest="50" 
                                    HeightRequest="50"/>
                        </Grid>
                    </Border>

                    <Label Grid.Row="1" Text="No active chats." TextColor="Gray" HorizontalOptions="Center" VerticalOptions="Center" IsVisible="{Binding IsListEmpty}"/>

                    <CollectionView x:Name="ChatListCollectionView" Grid.Row="1" SelectionMode="Single" SelectionChanged="OnChatSelected">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="local:ChatViewModel">
                                <Grid Padding="10" ColumnDefinitions="60,*" BackgroundColor="Transparent">

                                    <!-- AVATAR CONTAINER -->
                                    <Grid Grid.Column="0" HeightRequest="60" WidthRequest="60">
                                        <!-- 1. Letter Background (Dynamic Color) -->
                                        <Border StrokeShape="RoundRectangle 30" BackgroundColor="{Binding AvatarBgColor}" StrokeThickness="0">
                                            <Label Text="{Binding AvatarLetter}" TextColor="White" FontSize="24" FontAttributes="Bold" HorizontalOptions="Center" VerticalOptions="Center"/>
                                        </Border>

                                        <!-- 2. Image (If exists) -->
                                        <Image Source="{Binding AvatarUrl}" Aspect="AspectFill" HeightRequest="60" WidthRequest="60">
                                            <Image.Clip>
                                                <EllipseGeometry Center="30,30" RadiusX="30" RadiusY="30"/>
                                            </Image.Clip>
                                        </Image>

                                        <!-- 3. Online Status Dot (Bottom Right) -->
                                        <Border IsVisible="{Binding OnlineStatusVisible}"
                                                BackgroundColor="{Binding OnlineStatusColor}"
                                                Stroke="White" StrokeThickness="2"
                                                HeightRequest="16" WidthRequest="16"
                                                HorizontalOptions="End" VerticalOptions="End"
                                                Margin="0,0,2,2"
                                                StrokeShape="RoundRectangle 8"/>
                                    </Grid>

                                    <!-- TEXT INFO -->
                                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Padding="10,0,0,0">
                                        <!-- ✅ FIXED: Use FormattedString for display name with tag support -->
                                        <Label FormattedText="{Binding DisplayNameFormatted}"/>
                                        <Label Text="{Binding LastMessagePreview}" FontSize="14" TextColor="Gray" LineBreakMode="TailTruncation"/>
                                    </VerticalStackLayout>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Grid>
            </Grid>

            <!-- RIGHT: CHAT -->
            <local:ChatView x:Name="DesktopChatView" Grid.Column="1" IsVisible="{Binding IsDesktop}"/>
        </Grid>

        <!-- ✅ Menu Backdrop (Tap to close) - UPDATED with Opacity 0 -->
        <BoxView x:Name="MenuBackdrop" 
                 Color="Black" 
                 Opacity="0"
                 IsVisible="False" 
                 ZIndex="99"
                 InputTransparent="False">
            <BoxView.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnMenuBackdropTapped"/>
            </BoxView.GestureRecognizers>
        </BoxView>

        <!-- ✅ HAMBURGER MENU DRAWER (Overlay) - UPDATED for smooth animation -->
        <Border x:Name="MenuDrawer"
                Grid.Row="0"
                BackgroundColor="{Binding MainBgColor}"
                StrokeThickness="1"
                Stroke="Gray"
                Margin="0"
                Padding="0"
                IsVisible="False"
                ZIndex="100"
                WidthRequest="250"
                HorizontalOptions="Start"
                VerticalOptions="Fill"
                TranslationX="-250">

            <VerticalStackLayout Spacing="0" Padding="0">
                <!-- Menu Header -->
                <Border BackgroundColor="#3b82f6" Padding="20,15" StrokeThickness="0">
                    <Label Text="Menu" TextColor="White" FontSize="18" FontAttributes="Bold"/>
                </Border>

                <!-- Menu Items -->
                <VerticalStackLayout Spacing="0" Padding="0">

                    <!-- Dark Mode Toggle -->
                    <Border Padding="20,15" StrokeThickness="0" BackgroundColor="{Binding MainBgColor}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnToggleTheme"/>
                        </Border.GestureRecognizers>
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0" Text="Dark Mode" TextColor="{Binding TextColor}" FontSize="16" VerticalOptions="Center"/>
                            <Switch Grid.Column="1" x:Name="ThemeSwitch" IsToggled="{x:Static local:SettingsManager.IsDarkMode}" Toggled="OnToggleTheme" OnColor="#3b82f6"/>
                        </Grid>
                    </Border>

                    <!-- Divider -->
                    <BoxView HeightRequest="1" BackgroundColor="Gray" Opacity="0.3"/>

                    <!-- Settings -->
                    <Border Padding="20,15" StrokeThickness="0" BackgroundColor="{Binding MainBgColor}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnSettingsClicked"/>
                        </Border.GestureRecognizers>
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0" Text="Settings" TextColor="{Binding TextColor}" FontSize="16" VerticalOptions="Center"/>
                            <Label Grid.Column="1" Text="→" TextColor="#3b82f6" FontSize="20" VerticalOptions="Center"/>
                        </Grid>
                    </Border>

                    <!-- Divider -->
                    <BoxView HeightRequest="1" BackgroundColor="Gray" Opacity="0.3"/>

                    <!-- Logout -->
                    <Border Padding="20,15" StrokeThickness="0" BackgroundColor="{Binding MainBgColor}">
                        <Button Text="Logout" 
                                BackgroundColor="#ef4444" 
                                TextColor="White" 
                                Clicked="OnLogout"
                                CornerRadius="8"/>
                    </Border>
                </VerticalStackLayout>
            </VerticalStackLayout>
        </Border>

    </Grid>
</ContentPage>