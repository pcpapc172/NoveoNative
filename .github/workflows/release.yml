name: Create Release

# Trigger ONLY when you push a tag starting with "v" (e.g. v1.0, v1.0.5)
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # 1. BUILD ANDROID (Using your working command)
  build-android:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      - name: Install MAUI Workload
        run: dotnet workload install maui-android
      - name: Publish APK
        run: |
          dotnet publish NoveoNative/NoveoNative.csproj -f net9.0-android -c Release /p:TargetFrameworks=net9.0-android -p:AndroidPackageFormat=apk -p:AndroidKeyStore=false -p:RunAOTCompilation=false -p:AndroidLinkMode=None -p:AndroidEnableProguard=false -p:AndroidEnableSGenConcurrent=true -p:PublishTrimmed=false -p:TrimMode=none
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Android-APK
          path: NoveoNative/bin/Release/net9.0-android/publish/*.apk

  # 2. BUILD WINDOWS
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      - name: Install MAUI Workload
        run: dotnet workload install maui-windows
      - name: Publish Windows
        run: |
          dotnet publish NoveoNative/NoveoNative.csproj -f net9.0-windows10.0.19041.0 -c Release -p:TargetFrameworks=net9.0-windows10.0.19041.0 -p:WindowsPackageType=None -p:WindowsAppSDKSelfContained=true -p:PublishSingleFile=false --self-contained true
      
      # Zip the Windows build (because it has many files)
      - name: Zip Windows Build
        run: |
          powershell Compress-Archive -Path NoveoNative/bin/Release/net9.0-windows10.0.19041.0/win-x64/publish/* -DestinationPath NoveoWindows.zip
      
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Zip
          path: NoveoWindows.zip

  # 3. BUILD iOS
  build-ios:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      - name: Install MAUI Workload
        run: dotnet workload install maui-ios
      - name: Publish IPA
        run: |
          dotnet publish NoveoNative/NoveoNative.csproj -f net9.0-ios -c Release -p:TargetFrameworks=net9.0-ios -p:ArchiveOnBuild=true -p:RuntimeIdentifier=ios-arm64 -p:_SuppressSdkVersionCheck=true -p:CodesignKey="-" -p:CodesignProvision="" -o ./ios_output
      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iOS-IPA
          path: ios_output/*.ipa

  # 4. PUBLISH RELEASE (Runs after all builds finish)
  create-release:
    needs: [build-android, build-windows, build-ios]
    runs-on: ubuntu-latest
    steps:
      - name: Download Android Artifact
        uses: actions/download-artifact@v4
        with:
          name: Android-APK
          
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: Windows-Zip
          
      - name: Download iOS Artifact
        uses: actions/download-artifact@v4
        with:
          name: iOS-IPA

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
        
          # Attach the files we just downloaded
          files: |
            *.apk
            *.ipa
            NoveoWindows.zip
          generate_release_notes: true
          draft: false
          prerelease: false
