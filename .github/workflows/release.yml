name: Build, Release, Sign & Deploy

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:

  # 1. BUILD ANDROID
  build-android:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      - run: dotnet workload install maui-android

      - name: Publish Universal APK
        run: |
          dotnet publish NoveoNative/NoveoNative.csproj -f net9.0-android -c Release `
            -p:TargetFrameworks=net9.0-android `
            -p:AndroidPackageFormat=apk `
            -p:AndroidKeyStore=false `
            -p:RunAOTCompilation=false `
            -p:AndroidLinkMode=None `
            -p:PublishTrimmed=false `
            -p:AndroidUseAapt2=true `
            -p:AndroidCreatePackagePerAbi=false

      - name: Move Universal APK
        run: |
          $PUBLISH_DIR = "NoveoNative/bin/Release/net9.0-android/publish/"
          $APK = Get-ChildItem -Path $PUBLISH_DIR -Filter "*.apk" | Select-Object -First 1
          if ($null -eq $APK) { Write-Error "âŒ APK not found"; exit 1 }
          Move-Item -Path "$($APK.FullName)" -Destination "NoveoNative/NoveoNative-Universal-Unsigned.apk" -Force

      - uses: actions/upload-artifact@v4
        with:
          name: Android-Universal
          path: NoveoNative/NoveoNative-Universal-Unsigned.apk


  # 2. BUILD WINDOWS
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      - run: dotnet workload install maui-windows

      - name: Publish Windows
        run: |
          dotnet publish NoveoNative/NoveoNative.csproj -f net9.0-windows10.0.19041.0 -c Release `
            -p:TargetFrameworks=net9.0-windows10.0.19041.0 `
            -p:WindowsPackageType=None `
            -p:WindowsAppSDKSelfContained=true `
            -p:PublishSingleFile=true `
            -p:RuntimeIdentifier=win-${{ matrix.arch }} `
            --self-contained true

      - run: powershell Compress-Archive -Path NoveoNative/bin/Release/net9.0-windows10.0.19041.0/win-${{ matrix.arch }}/publish/* -DestinationPath "NoveoNative-Windows-${{ matrix.arch }}.zip"

      - uses: actions/upload-artifact@v4
        with:
          name: Windows-${{ matrix.arch }}
          path: NoveoNative-Windows-${{ matrix.arch }}.zip


  # 3. BUILD macOS
  build-macos:
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      - run: dotnet workload install maui

      - name: Publish MacCatalyst
        run: |
          dotnet publish NoveoNative/NoveoNative.csproj -f net9.0-maccatalyst -c Release \
            -p:CreatePackage=false \
            -p:RuntimeIdentifier=maccatalyst-arm64 \
            -p:CodesignKey="-" \
            -p:CodesignProvision="" \
            -p:UseAppBundle=true

      - name: Find and Zip App
        run: |
          APP_PATH=$(find NoveoNative/bin -name "NoveoNative.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then echo "âŒ App not found"; exit 1; fi
          PARENT_DIR=$(dirname "$APP_PATH")
          APP_NAME=$(basename "$APP_PATH")
          cd "$PARENT_DIR"
          zip -r NoveoNative-macOS-arm64.zip "$APP_NAME"
          mv NoveoNative-macOS-arm64.zip $GITHUB_WORKSPACE/

      - uses: actions/upload-artifact@v4
        with:
          name: macOS-App
          path: NoveoNative-macOS-arm64.zip


  # 4. BUILD iOS
  build-ios:
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      - run: dotnet workload install maui

      - name: Publish iOS IPA
        run: |
          dotnet publish NoveoNative/NoveoNative.csproj -f net9.0-ios -c Release \
            -p:ArchiveOnBuild=true \
            -p:RuntimeIdentifier=ios-arm64 \
            -p:_SuppressSdkVersionCheck=true \
            -p:CodesignKey="-" \
            -p:CodesignProvision=""

      - uses: actions/upload-artifact@v4
        with:
          name: iOS-IPA-Unsigned
          path: '**/*.ipa'


  # 5. CREATE RELEASE
  create-release:
    needs: [build-android, build-windows, build-macos, build-ios]
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
    steps:
      - id: get_tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release
        run: |
          mkdir release_files
          find artifacts -type f \( -name "*.apk" -o -name "*.ipa" -o -name "*.zip" \) -exec cp {} release_files/ \;
          IPA=$(find release_files -name "*.ipa" | head -1)
          [ -n "$IPA" ] && mv "$IPA" release_files/NoveoNative-unsigned.ipa || true

      - uses: softprops/action-gh-release@v1
        with:
          files: release_files/*
          generate_release_notes: true


  # 6. SIGN iOS & DEPLOY âœ… DEPLOY_TOKEN FIX HERE
  sign-and-deploy:
    needs: create-release
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
        with:
          repository: pcpapc172/noveo-native-install
          ref: gh-pages
          token: ${{ secrets.DEPLOY_TOKEN }}

      - name: Configure Git Auth
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.DEPLOY_TOKEN }}@github.com/pcpapc172/noveo-native-install.git

      - name: Clean Repo
        run: |
          git rm -rf --ignore-unmatch zsign temp certificate.p12 profile.mobileprovision unsigned.ipa ipa-download NoveoNative || true
          rm -rf zsign temp certificate.p12 profile.mobileprovision unsigned.ipa ipa-download NoveoNative

      - uses: actions/download-artifact@v4
        with:
          name: iOS-IPA-Unsigned
          path: ipa-download

      - name: Sign IPA
        id: sign
        run: |
          set -x
          brew install pkg-config openssl minizip
          git clone https://github.com/zhlynn/zsign.git
          cd zsign/build/macos && make && sudo cp ../../bin/zsign /usr/local/bin/ && cd ../../..

          IPA_FILE=$(find ./ipa-download -name "*.ipa" | head -1)
          cp "$IPA_FILE" unsigned.ipa

          echo "${{ secrets.P12_CERTIFICATE }}" | base64 --decode > certificate.p12
          echo "${{ secrets.PROVISIONING_PROFILE }}" | base64 --decode > profile.mobileprovision

          zsign -k certificate.p12 -p "${{ secrets.P12_PASSWORD }}" -m profile.mobileprovision -o NoveoNative.ipa unsigned.ipa

          SIZE=$(stat -f%z NoveoNative.ipa)
          echo "ipa_size=$SIZE" >> $GITHUB_OUTPUT

          unzip -q NoveoNative.ipa -d temp
          BUNDLE_ID=$(plutil -extract CFBundleIdentifier raw "temp/Payload/NoveoNative.app/Info.plist")
          echo "bundle_id=$BUNDLE_ID" >> $GITHUB_OUTPUT

      - name: Write version.txt
        run: echo "${{ needs.create-release.outputs.tag }}" > version.txt

      - name: Write manifest.plist
        run: |
          TAG="${{ needs.create-release.outputs.tag }}"
          BID="${{ steps.sign.outputs.bundle_id }}"

          cat > manifest.plist << PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>items</key>
            <array>
              <dict>
                <key>assets</key>
                <array>
                  <dict>
                    <key>kind</key>
                    <string>software-package</string>
                    <key>url</key>
                    <string>https://pcpapc172.github.io/noveo-native-install/NoveoNative.ipa</string>
                  </dict>
                </array>
                <key>metadata</key>
                <dict>
                  <key>bundle-identifier</key>
                  <string>$BID</string>
                  <key>bundle-version</key>
                  <string>$TAG</string>
                  <key>kind</key>
                  <string>software</string>
                  <key>title</key>
                  <string>NoveoNative</string>
                </dict>
              </dict>
            </array>
          </dict>
          </plist>
          PLIST

      - name: Write apps.json
        run: |
          TAG="${{ needs.create-release.outputs.tag }}"
          BID="${{ steps.sign.outputs.bundle_id }}"
          SZ="${{ steps.sign.outputs.ipa_size }}"
          VERSION_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          cat > apps.json << JSON
          {
            "name": "NoveoNative Repository",
            "identifier": "com.noveo.repo",
            "sourceURL": "https://pcpapc172.github.io/noveo-native-install/apps.json",
            "apps": [
              {
                "name": "NoveoNative",
                "bundleIdentifier": "$BID",
                "developerName": "PCPA",
                "subtitle": "Modern Messenger for iOS",
                "version": "$TAG",
                "versionDate": "$VERSION_DATE",
                "versionDescription": "Latest release",
                "downloadURL": "https://pcpapc172.github.io/noveo-native-install/NoveoNative.ipa",
                "localizedDescription": "Modern messaging app",
                "size": $SZ
              }
            ]
          }
          JSON

      - name: Cleanup & Commit
        run: |
          rm -rf zsign temp certificate.p12 profile.mobileprovision unsigned.ipa ipa-download NoveoNative

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "ðŸš€ Deploy ${{ needs.create-release.outputs.tag }}"
          git push origin gh-pages
