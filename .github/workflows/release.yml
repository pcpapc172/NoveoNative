name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # 1. BUILD ANDROID
  build-android:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      - name: Install MAUI Workload
        run: dotnet workload install maui-android
      - name: Publish APK
        # Includes fixes for resources and trimming
        run: |
          dotnet publish NoveoNative/NoveoNative.csproj -f net9.0-android -c Release -p:TargetFrameworks=net9.0-android -p:AndroidPackageFormat=apk -p:AndroidKeyStore=false -p:RunAOTCompilation=false -p:AndroidLinkMode=None -p:PublishTrimmed=false -p:SatelliteResourceLanguages="en"
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Android-APK
          path: NoveoNative/bin/Release/net9.0-android/publish/*.apk

  # 2. BUILD WINDOWS
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      - name: Install MAUI Workload
        run: dotnet workload install maui-windows
      - name: Publish Windows
        # Includes fixes for platform targeting
        run: |
          dotnet publish NoveoNative/NoveoNative.csproj -f net9.0-windows10.0.19041.0 -c Release -p:TargetFrameworks=net9.0-windows10.0.19041.0 -p:WindowsPackageType=None -p:WindowsAppSDKSelfContained=true -p:PublishSingleFile=false --self-contained true
      
      - name: Zip Windows Build
        run: |
          powershell Compress-Archive -Path NoveoNative/bin/Release/net9.0-windows10.0.19041.0/win-x64/publish/* -DestinationPath NoveoWindows.zip
      
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Zip
          path: NoveoWindows.zip

  # 3. BUILD iOS
  build-ios:
    # Set to macos-26 as requested. 
    # If this fails with "Runner not found", GitHub hasn't added the label yet -> switch to 'macos-latest'
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      - name: Install MAUI Workload
        run: dotnet workload install maui-ios
      - name: Publish IPA
        # Uses Ad-Hoc signing (-) and Suppresses Version Check to fix the .NET 9 bug
        run: |
          dotnet publish NoveoNative/NoveoNative.csproj -f net9.0-ios -c Release -p:TargetFrameworks=net9.0-ios -p:ArchiveOnBuild=true -p:RuntimeIdentifier=ios-arm64 -p:_SuppressSdkVersionCheck=true -p:CodesignKey="-" -p:CodesignProvision="" -o ./ios_output
      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iOS-IPA
          path: ios_output/*.ipa

  # 4. PUBLISH RELEASE
  create-release:
    needs: [build-android, build-windows, build-ios]
    runs-on: ubuntu-latest
    steps:
      - name: Download Android Artifact
        uses: actions/download-artifact@v4
        with:
          name: Android-APK
          
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: Windows-Zip
          
      - name: Download iOS Artifact
        uses: actions/download-artifact@v4
        with:
          name: iOS-IPA

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.apk
            *.ipa
            NoveoWindows.zip
          generate_release_notes: true
          draft: false
          prerelease: false
