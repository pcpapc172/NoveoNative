name: Build, Release, Sign & Deploy

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # 1. BUILD ANDROID (MULTIPLE ARCHITECTURES)
  build-android:
    runs-on: windows-latest
    strategy:
      matrix:
        abi: [arm64-v8a, armeabi-v7a, x86, x86_64]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      
      - name: Install MAUI Workload
        run: dotnet workload install maui-android
      
      - name: Publish APK for ${{ matrix.abi }}
        run: |
          dotnet publish NoveoNative/NoveoNative.csproj -f net9.0-android -c Release `
            -p:TargetFrameworks=net9.0-android `
            -p:AndroidPackageFormat=apk `
            -p:AndroidKeyStore=false `
            -p:RunAOTCompilation=false `
            -p:AndroidLinkMode=None `
            -p:PublishTrimmed=false `
            -p:SatelliteResourceLanguages="en" `
            -p:AndroidUseAapt2=true `
            -p:AndroidSupportedAbis=${{ matrix.abi }} `
            -p:AndroidCreatePackagePerAbi=true
      
      - name: Align & Sign APK
        run: |
          # Find the APK
          $APK = Get-ChildItem -Path "NoveoNative/bin/Release/net9.0-android/publish/" -Filter "*.apk" | Select-Object -First 1
          
          if ($null -eq $APK) {
            Write-Host "âŒ APK not found for ${{ matrix.abi }}!"
            exit 1
          }
          
          $APK_NAME = $APK.BaseName
          $APK_PATH = $APK.FullName
          
          Write-Host "âœ… Found APK: $APK_NAME"
          Write-Host "ðŸ“¦ Architecture: ${{ matrix.abi }}"
          
          # Align APK
          $ANDROID_HOME = "C:\Users\${{ env:USERNAME }}\AppData\Local\Android\sdk"
          $ZIPALIGN = "$ANDROID_HOME\build-tools\34.0.0\zipalign.exe"
          
          if (-not (Test-Path $ZIPALIGN)) {
            Write-Host "âš ï¸ zipalign not found, trying alternative path..."
            $ZIPALIGN = "$ANDROID_HOME\build-tools\35.0.0\zipalign.exe"
          }
          
          & $ZIPALIGN -v 4 "$APK_PATH" "aligned.apk"
          
          # Create architecture-specific name
          $ABI_SHORT = "${{ matrix.abi }}" -replace "-v8a", "" -replace "armeabi-", "" -replace "x86_64", "x64"
          $SIGNED_APK = "com.companyname.noveonative-$ABI_SHORT-signed.apk"
          
          Remove-Item "$APK_PATH"
          Rename-Item "aligned.apk" "$SIGNED_APK"
          
          Write-Host "âœ… APK aligned and renamed: $SIGNED_APK"
          Copy-Item "$SIGNED_APK" "NoveoNative/bin/Release/net9.0-android/publish/"
      
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Android-APK-${{ matrix.abi }}
          path: NoveoNative/bin/Release/net9.0-android/publish/*.apk

  # 2. BUILD WINDOWS (MULTIPLE ARCHITECTURES)
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      
      - name: Install MAUI Workload
        run: dotnet workload install maui-windows
      
      - name: Publish Windows ${{ matrix.arch }}
        run: |
          dotnet publish NoveoNative/NoveoNative.csproj -f net9.0-windows10.0.19041.0 -c Release `
            -p:TargetFrameworks=net9.0-windows10.0.19041.0 `
            -p:WindowsPackageType=None `
            -p:WindowsAppSDKSelfContained=true `
            -p:PublishSingleFile=true `
            -p:RuntimeIdentifier=win-${{ matrix.arch }} `
            --self-contained true
      
      - name: Zip Windows ${{ matrix.arch }} Build
        run: |
          powershell Compress-Archive -Path NoveoNative/bin/Release/net9.0-windows10.0.19041.0/win-${{ matrix.arch }}/publish/* -DestinationPath "NoveoNative-Windows-${{ matrix.arch }}.zip"
      
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-${{ matrix.arch }}
          path: NoveoNative-Windows-${{ matrix.arch }}.zip

  # 3. BUILD LINUX (MULTIPLE ARCHITECTURES)
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      
      - name: Install dependencies for ${{ matrix.arch }}
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2 libssl3
          
          if [ "${{ matrix.arch }}" == "arm64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          fi
      
      - name: Publish Linux ${{ matrix.arch }}
        run: |
          dotnet publish NoveoNative/NoveoNative.csproj -f net9.0 -c Release \
            -p:RuntimeIdentifier=linux-${{ matrix.arch }} \
            -p:PublishSingleFile=true \
            -p:SelfContained=true \
            -o ./linux-publish-${{ matrix.arch }}
      
      - name: Create AppImage for ${{ matrix.arch }}
        run: |
          ARCH_NAME="${{ matrix.arch }}"
          if [ "$ARCH_NAME" == "x64" ]; then
            ARCH_APPIMAGE="x86_64"
          else
            ARCH_APPIMAGE="aarch64"
          fi
          
          echo "ðŸŽ Creating AppImage for $ARCH_APPIMAGE..."
          
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/512x512/apps
          
          # Copy binary
          cp linux-publish-${{ matrix.arch }}/NoveoNative AppDir/usr/bin/
          chmod +x AppDir/usr/bin/NoveoNative
          
          # Create desktop file
          cat > AppDir/usr/share/applications/noveonative.desktop << 'EOF'
          [Desktop Entry]
          Name=NoveoNative
          Comment=Modern Messenger
          Exec=NoveoNative
          Type=Application
          Icon=noveonative
          Categories=Communication;
          EOF
          
          # Create AppRun script
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
          export LD_LIBRARY_PATH="$SCRIPT_DIR/usr/lib:$LD_LIBRARY_PATH"
          exec "$SCRIPT_DIR/usr/bin/NoveoNative" "$@"
          EOF
          chmod +x AppDir/AppRun
          
          # Download appimagetool
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-${ARCH_APPIMAGE}.AppImage
          chmod +x appimagetool-${ARCH_APPIMAGE}.AppImage
          
          # Create AppImage
          ./appimagetool-${ARCH_APPIMAGE}.AppImage AppDir NoveoNative-Linux-${{ matrix.arch }}.AppImage
          
          echo "âœ… AppImage created: NoveoNative-Linux-${{ matrix.arch }}.AppImage"
          ls -lh NoveoNative-Linux-${{ matrix.arch }}.AppImage
      
      - name: Create Linux tarball
        run: |
          cd linux-publish-${{ matrix.arch }}
          tar -czf ../NoveoNative-Linux-${{ matrix.arch }}.tar.gz .
          cd ..
      
      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Linux-${{ matrix.arch }}
          path: |
            NoveoNative-Linux-${{ matrix.arch }}.AppImage
            NoveoNative-Linux-${{ matrix.arch }}.tar.gz

  # 4. BUILD iOS (UNSIGNED)
  build-ios:
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      
      - name: Install MAUI Workload
        run: dotnet workload install maui
      
      - name: Publish iOS IPA
        run: |
          dotnet publish NoveoNative/NoveoNative.csproj -f net9.0-ios -c Release -p:ArchiveOnBuild=true -p:RuntimeIdentifier=ios-arm64 -p:_SuppressSdkVersionCheck=true -p:CodesignKey="-" -p:CodesignProvision=""
      
      - name: Upload iOS Artifact (Unsigned)
        uses: actions/upload-artifact@v4
        with:
          name: iOS-IPA-Unsigned
          path: '**/*.ipa'

  # 5. CREATE RELEASE
  create-release:
    needs: [build-android, build-windows, build-linux, build-ios]
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.get_tag.outputs.tag }}
    steps:
      - name: Get tag name
        id: get_tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Organize files for release
        run: |
          echo "ðŸ“‚ Organizing artifacts..."
          cd artifacts
          
          # Find and organize all files
          find . -type f \( -name "*.apk" -o -name "*.ipa" -o -name "*.zip" -o -name "*.tar.gz" -o -name "*.AppImage" \) | while read file; do
            echo "Found: $file"
            cp "$file" ./
          done
          
          # Rename unsigned IPA
          IPA=$(find . -name "*.ipa" -type f | head -1)
          if [ -n "$IPA" ]; then
            echo "âœ… Found IPA: $IPA"
            cp "$IPA" ./NoveoNative-unsigned.ipa
          fi
          
          echo "ðŸ“‹ Files ready for release:"
          ls -lah | grep -E "\.(apk|ipa|zip|tar\.gz|AppImage)$"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/*.apk
            artifacts/NoveoNative-unsigned.ipa
            artifacts/NoveoNative-Windows-*.zip
            artifacts/NoveoNative-Linux-*.tar.gz
            artifacts/NoveoNative-Linux-*.AppImage
          generate_release_notes: true
          draft: false
          prerelease: false

  # 6. SIGN iOS IPA & DEPLOY
  sign-and-deploy:
    needs: create-release
    runs-on: macos-26
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          repository: pcpapc172/noveo-native-install
          ref: gh-pages
          token: ${{ secrets.DEPLOY_TOKEN }}
      
      - name: Download Unsigned IPA
        uses: actions/download-artifact@v4
        with:
          name: iOS-IPA-Unsigned
          path: ./ipa-download
      
      - name: Find and Move IPA
        run: |
          echo "ðŸ“‚ Finding IPA..."
          find ./ipa-download -name "*.ipa" -type f
          
          IPA_FILE=$(find ./ipa-download -name "*.ipa" -type f | head -1)
          
          if [ -z "$IPA_FILE" ]; then
            echo "âŒ No IPA found!"
            exit 1
          fi
          
          echo "âœ… Found: $IPA_FILE"
          mv "$IPA_FILE" unsigned.ipa
          ls -la
      
      - name: Build Zsign
        run: |
          echo "ðŸ“¦ Building Zsign..."
          brew install pkg-config openssl minizip
          git clone https://github.com/zhlynn/zsign.git
          cd zsign/build/macos
          make clean && make
          sudo cp ../../bin/zsign /usr/local/bin/
          cd ../../..
          rm -rf zsign
      
      - name: Setup Certificate & Profile
        run: |
          echo "ðŸ” Setting up certificate and profile..."
          echo "${{ secrets.P12_CERTIFICATE }}" | base64 --decode > certificate.p12
          echo "${{ secrets.PROVISIONING_PROFILE }}" | base64 --decode > profile.mobileprovision
          
          echo "ðŸ“‹ Files created:"
          ls -lah certificate.p12 profile.mobileprovision
      
      - name: Sign IPA with Zsign
        id: sign
        run: |
          echo "âœï¸ Signing IPA..."
          
          /usr/local/bin/zsign -k certificate.p12 -p "${{ secrets.P12_PASSWORD }}" \
            -m profile.mobileprovision -o NoveoNative.ipa unsigned.ipa
          
          if [ ! -f NoveoNative.ipa ]; then
            echo "âŒ Signing failed"
            exit 1
          fi
          
          SIZE=$(stat -f%z NoveoNative.ipa)
          echo "ipa_size=$SIZE" >> $GITHUB_OUTPUT
          
          # Extract Bundle ID
          unzip -q NoveoNative.ipa -d temp_extract
          APP_PATH=$(find temp_extract/Payload -name "*.app" -type d -depth 1 | head -1)
          BUNDLE_ID=$(plutil -extract CFBundleIdentifier raw "$APP_PATH/Info.plist" 2>/dev/null || echo "com.etisalat.INDY")
          rm -rf temp_extract
          
          echo "bundle_id=$BUNDLE_ID" >> $GITHUB_OUTPUT
          rm -f certificate.p12 profile.mobileprovision unsigned.ipa
      
      - name: Update manifest.plist
        run: |
          cat > manifest.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>items</key>
              <array>
                  <dict>
                      <key>assets</key>
                      <array>
                          <dict>
                              <key>kind</key>
                              <string>software-package</string>
                              <key>url</key>
                              <string>https://pcpapc172.github.io/noveo-native-install/NoveoNative.ipa</string>
                          </dict>
                      </array>
                      <key>metadata</key>
                      <dict>
                          <key>bundle-identifier</key>
                          <string>${{ steps.sign.outputs.bundle_id }}</string>
                          <key>bundle-version</key>
                          <string>${{ needs.create-release.outputs.tag_name }}</string>
                          <key>kind</key>
                          <string>software</string>
                          <key>title</key>
                          <string>NoveoNative</string>
                      </dict>
                  </dict>
              </array>
          </dict>
          </plist>
          EOF
      
      - name: Update apps.json
        run: |
          cat > apps.json << EOF
          {
            "name": "NoveoNative Repository",
            "identifier": "com.noveo.repo",
            "sourceURL": "https://pcpapc172.github.io/noveo-native-install/apps.json",
            "apps": [
              {
                "name": "NoveoNative",
                "bundleIdentifier": "${{ steps.sign.outputs.bundle_id }}",
                "developerName": "PCPA",
                "subtitle": "Modern Messenger for iOS",
                "version": "${{ needs.create-release.outputs.tag_name }}",
                "versionDate": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
                "versionDescription": "Latest release",
                "downloadURL": "https://pcpapc172.github.io/noveo-native-install/NoveoNative.ipa",
                "localizedDescription": "Modern messaging app",
                "iconURL": "https://pcpapc172.github.io/noveo-native-install/assets/icon512.png",
                "tintColor": "#3b82f6",
                "size": ${{ steps.sign.outputs.ipa_size }}
              }
            ]
          }
          EOF
      
      - name: Save version
        run: echo "${{ needs.create-release.outputs.tag_name }}" > version.txt
      
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ðŸš€ Deploy ${{ needs.create-release.outputs.tag_name }}"
          git push origin gh-pages
      
      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ needs.create-release.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± Android (4 arch)" >> $GITHUB_STEP_SUMMARY
          echo "- arm64-v8a, armeabi-v7a, x86, x86_64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸªŸ Windows (2 arch)" >> $GITHUB_STEP_SUMMARY
          echo "- x64, arm64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ Linux (2 arch + AppImage)" >> $GITHUB_STEP_SUMMARY
          echo "- x64 (tar.gz + AppImage), arm64 (tar.gz + AppImage)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ iOS" >> $GITHUB_STEP_SUMMARY
          echo "- Signed & deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Install:** https://pcpapc172.github.io/noveo-native-install/" >> $GITHUB_STEP_SUMMARY
